# Документация по тестированию

## Обзор
Этот документ описывает тестовое покрытие проекта namedot, в частности, фокусируясь на аутентификации REST API и функциональности репликации.

## Структура тестов

### Тесты аутентификации REST (`internal/server/rest/auth_test.go`)

Комплексные unit-тесты для middleware аутентификации REST API.

#### Тестовое покрытие

**1. Аутентификация по хэшу токена**
- Аутентификация с валидным bcrypt-хэшем токена
- Отклонение невалидного токена
- Обработка отсутствующего токена

**2. Аутентификация по plain text токену** (устаревшее)
- Аутентификация с валидным plain text токеном
- Отклонение невалидного токена
- Fallback поведение когда хэш не настроен

**3. Аутентификация не настроена**
- Разрешающее поведение (пропускает все запросы)
- Документация рекомендаций по безопасности
- Граничные случаи с токенами когда аутентификация отключена

**4. Граничные случаи безопасности**
- Обработка префикса Bearer (чувствительно к регистру)
- Обработка пустого токена
- Токен без префикса Bearer
- Настроены оба токена (хэш и plain)

**5. Рекомендации по безопасности**
Тесты документируют важные соображения безопасности:
- Когда аутентификация не настроена, API пропускает все запросы
- Рекомендуется: требовать явную конфигурацию или использовать fail-safe по умолчанию
- Тесты предоставляют документацию для будущих улучшений безопасности

#### Запуск тестов аутентификации

```bash
# Запустить все тесты аутентификации
go test -v ./internal/server/rest -run TestAuth

# Запустить с покрытием
go test -cover ./internal/server/rest -run TestAuth
```

### Тесты репликации (`internal/server/rest/replication_test.go`)

Table-driven тесты для функциональности master-slave репликации, покрывающие операции экспорта и импорта.

#### Тестовое покрытие

**1. Тесты экспорта (`TestSyncExport`)**
- Экспорт пустой базы данных
- Экспорт одной зоны с записями
- Экспорт нескольких зон с записями
- Экспорт шаблонов с записями
- Экспорт комбинации зон и шаблонов
- Правильная предзагрузка связей (RRSets, Records)

**2. Тесты импорта (`TestSyncImport`)**
- Создание новой зоны
- Обработка конфликтующей зоны (замена старых записей)
- Создание нового шаблона
- Обработка конфликтующего шаблона (обновление и замена)
- Множественные зоны и шаблоны
- Geo-aware записи шаблонов (Country, Continent, ASN, Subnet)
- Отклонение невалидного JSON

**3. Разрешение конфликтов**
Тесты проверяют, что импорт правильно обрабатывает существующие данные:
- Существующие зоны: старые RRSets и Records удаляются полностью (Unscoped)
- Существующие шаблоны: Description обновляется, старые записи удаляются полностью
- Не остается маркеров soft-delete

**4. Целостность данных**
- Откат транзакции при ошибках (документированное ограничение SQLite)
- Проверка полного удаления (нет мягко удаленных записей)
- Сохранение geo-атрибутов
- Целостность связей между записями

**5. Граничные случаи**
- Пустые данные импорта
- Невалидные JSON данные
- Отсутствующие обязательные поля
- Ограничения базы данных

#### Запуск тестов репликации

```bash
# Запустить все тесты репликации
go test -v ./internal/server/rest -run TestSync

# Запустить с покрытием
go test -cover ./internal/server/rest -run TestSync

# Запустить все REST тесты
go test -v ./internal/server/rest
```

## Статистика тестов

```bash
# Запустить тесты аутентификации и репликации
go test -v ./internal/server/rest -run "TestAuth|TestSync"

# Покрытие: ~26% пакета internal/server/rest
go test -cover ./internal/server/rest -run "TestAuth|TestSync"
```

## Вспомогательные функции тестов

### `setupTestServer(t *testing.T, cfg *config.Config)`
Настраивает SQLite базу данных в памяти с правильной миграцией схемы для тестирования.

### `setupTestDB(t *testing.T)`
Создает и мигрирует базу данных в памяти для тестов репликации.

### `stringPtr(s string) *string`
Вспомогательная функция для создания указателей на строки (необходимо для geo-aware полей).

## Важные замечания

### Ограничения SQLite
Тесты используют SQLite базы данных в памяти, которые имеют некоторые ограничения:
- Поведение отката транзакций отличается от PostgreSQL/MySQL
- Некоторые нарушения ограничений могут не срабатывать в SQLite
- Production базы данных (Postgres/MySQL) имеют более полную проверку ограничений

### Соображения безопасности
1. **Тесты аутентификации** документируют текущее разрешающее поведение когда аутентификация не настроена
2. Тесты включают рекомендации по улучшению настроек безопасности по умолчанию
3. Граничные случаи документированы для осведомленности

### Hard Delete vs Soft Delete
- Тесты проверяют, что репликация использует полное удаление (Unscoped)
- Старые записи полностью удаляются, а не просто помечаются как удаленные
- Это важно для согласованности данных в master-slave репликации

## Будущие улучшения

1. **Аутентификация**
   - Добавить тесты для контроля доступа по IP (CIDR whitelist)
   - Тестировать аутентификацию на основе сертификатов
   - Тестировать rate limiting

2. **Репликация**
   - Тестировать одновременные операции импорта/экспорта
   - Тестировать частичные сбои синхронизации и восстановление
   - Тестировать производительность на больших наборах данных
   - Добавить интеграционные тесты с реальной master-slave настройкой

3. **Интеграционные тесты**
   - End-to-end тесты репликации
   - Разрешение конфликтов в нескольких зонах
   - Сценарии сетевых сбоев
   - Таймирование и планирование синхронизации

## Связанная документация

- [Улучшения безопасности](./SECURITY_IMPROVEMENTS.ru.md) - CSRF и безопасность cookie
- [Руководство по репликации](./REPLICATION.md) - Настройка и конфигурация master-slave
- [Основной README](./README.md) - Полная документация проекта
